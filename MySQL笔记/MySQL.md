# MySQL 笔记

## [MySQL查询过程](./MySQL_001.png)

## 数据库连接方式

1. 长连接：连接成功后，如果客户端持续有请求，则一直使用同一个连接
1. 短连接：每次执行完很少的几次查询就断开连接，下次查询再重新建立一个

* 注
  * 因为连接过程比较复杂，所以推荐长连接
  * 使用长连接时，MySQL在执行过程中临时的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。
  * 定期断开长连接 或者 MySQL5.7 之后可使用mysql_reset_connection来重新初始化连接资源(此过程不会重新连接和新做权限验证，会将连接恢复到刚刚创建完时的状态)

## MySQL更新语句执行过程

  主流程同查询过程

### 重要的日志模块 redo log模块

  更新时会用到[WAL(Write-Ahead Logging)技术](./MySQL_002.jpeg)，redo log模块
  
  [过程](./MySQL_003.jpeg)

### 重要的日志模块 binlog模块

  [为何会有两个日志模块？](./MySQL_004.jpeg)

  [更新语句执行过程](./MySQL_005.jpeg)
  
### 索引

* 索引常见模型
  * 哈希表：hash函数就是根据key计算出应该存储地址的位置，而哈希表是基于哈希函数建立的一种查找表
    * 地址index=H(key)
    * 哈希冲突 即H(key1) = H(key1)
    * 哈希表只适用于做等值查询(结构不是有序的，新增是往后追加)，不适用于范围查找，新增很快
  * 有序数组
    * 在等值查询和范围查询场景中的性能就都非常优秀(二分法)
    * 新增时很耗费资源(插入时，后面的数据需要依次递增)
    * 有序数组索引只适用于静态存储引擎
  * 搜索树
    * N叉树
  * 其他 跳表，LSM树 等
* InnoDB中使用B+树索引模型
  * 主键索引和普通索引的查询有什么区别？  
    `假设ID为主键 字段k 建立普通索引`  
    `如果语句是 select * from T where ID = 500 即主键查询方式 ，则只需要搜索 ID 这棵 B+ 树`  
    `如果语句是 select * from T where k=5，即普通索引查询方式，则需要先搜索 k 索引树，得到 ID 的值，再到 ID 索引树搜索一次。这个过程称为回表`  
    `也就是说，基于非主键索引的查询需要多扫描一棵索引树。因此，我们在应用中应该尽量使用主键查询。`
