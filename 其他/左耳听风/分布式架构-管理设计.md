#

## 2020-01-08

### 分布式锁

在多线程情况下访问一些共享资源需要加锁，不然就会出现数据被写乱的问题。
在分布式系统下，也是一样的。只不过，需要一个分布式的锁服务。对于分布式的锁服务，一般可以用数据库 DB、Redis 和 ZooKeeper 等实现。且具备以下特点:

* 安全性（Safety）：在任意时刻，只有一个客户端可以获得锁（排他性）。
* 避免死锁：客户端最终一定可以获得锁，即使锁住某个资源的客户端在释放锁之前崩溃或者网络不可达。
* 容错性：只要锁服务集群中的大部分节点存活，Client 就可以进行加锁解锁操作。Redis 的分布式锁服务

## 2020-01-10

### 配置中心

### 配置中心的设计

* 按运行环境分。一般来说，会有开发环境、测试环境、预发环境、生产环境。这些环境上的运行配置都不完全一样，但是理论来说，应该是大同小异的。
* 按依赖区分。一种是依赖配置，一种是不依赖的内部配置。比如，外部依赖的 MySQL 或 Redis 的连接配置。还有一种完全是自己内部的配置。
* 按层次分。就像云计算一样，配置也可以分成 IaaS、PaaS、SaaS 三层。基础层的配置是操作系统的配置，中间平台层的配置是中间件的配置，如 Tomcat 的配置，上层软件层的配置是应用自己的配置。

## 2020-01-14

### 边车模式

边车模式有时候也叫搭档模式，或是伴侣模式，或是跟班模式。编程的本质就是将控制和逻辑分离和解耦，而边车模式也是异曲同工，同样是让分布式架构中做到逻辑和控制分离。

### 服务网络

> Service Mesh 这个服务网络专注于处理服务和服务间的通讯。其主要负责构造一个稳定可靠的服务通讯的基础设施，并让整个架构更为的先进和 Cloud Native。在工程中，Service Mesh 基本来说是一组轻量级的服务代理和应用逻辑的服务在一起，并且对于应用服务是透明的。

说白了，就是下面几个特点。
* Service Mesh 是一个基础设施。
* Service Mesh 是一个轻量的服务通讯的网络代理。
* Service Mesh 对于应用服务来说是透明无侵入的。
* Service Mesh 用于解耦和分离分布式系统架构中控制层面上的东西。

### 网关模式

网关模式设计一个网关需要有以下的功能。

1. `请求路由` 因为不再是 Sidecar 了，所以网关一定要有请求路由的功能。这样一来，对于调用端来说，也是一件非常方便的事情。因为调用端不需要知道自己需要用到的其它服务的地址，全部统一地交给 Gateway 来处理。
1. `服务注册` 为了能够代理后面的服务，并把请求路由到正确的位置上，网关应该有服务注册功能，也就是后端的服务实例可以把其提供服务的地址注册、取消注册。一般来说，注册也就是注册一些 API 接口。比如，HTTP 的 Restful 请求，可以注册相应 API 的 URI、方法、HTTP 头。 这样，Gateway 就可以根据接收到的请求中的信息来决定路由到哪一个后端的服务上。
1. `负载均衡` 因为一个网关可以接收多个服务实例，所以网关还需要在各个对等的服务实例上做负载均衡策略。简单点就是直接 Round-Robin 轮询，复杂点的可以设置上权重进行分发，再复杂一点还可以做到 session 粘连。
1. 弹力设计。网关还可以把弹力设计中的那些异步、重试、幂等、流控、熔断、监视等都可以实现进去。这样，同样可以像 Service Mesh 那样，让应用服务只关心自己的业务逻辑（或是说数据面上的事）而不是控制逻辑（控制面）。
1. `安全方面` SSL 加密及证书管理、Session 验证、授权、数据校验，以及对请求源进行恶意攻击的防范。错误处理越靠前的位置就是越好，所以，网关可以做到一个全站的接入组件来对后端的服务进行保护。当然，网关还可以做更多更有趣的事情，比如：
1. `灰度发布` 网关完全可以做到对相同服务不同版本的实例进行导流，还可以收集相关的数据。这样对于软件质量的提升，甚至产品试错都有非常积极的意义。
1. `API聚合` 使用网关可以将多个单独请求聚合成一个请求。在微服务体系的架构中，因为服务变小了，所以一个明显的问题是，客户端可能需要多次请求才能得到所有的数据。这样一来，客户端与后端之间的频繁通信会对应用程序的性能和规模产生非常不利的影响。于是，我们可以让网关来帮客户端请求多个后端的服务（有些场景下完全可以并发请求），然后把后端服务的响应结果拼装起来，回传给客户端（当然，这个过程也可以做成异步的，但这需要客户端的配合）。
1. `API编排` 同样在微服务的架构下，要走完一个完整的业务流程，我们需要调用一系列 API，就像一种工作流一样，这个事完全可以通过网页来编排这个业务

### 部署升级策略

1. 停机部署(Big Bang / Recreate) 把现有版本的服务停机，然后部署新的版本。
1. 蓝绿部署(Blue/Green /Stage) 部署好新版本后，把流量从老服务那边切过来。
1. 滚动部署(Rolling Update / Ramped) 一点一点地升级现有的服务。
1. 灰度部署(Canary) 把一部分用户切到新版本上来，然后看一下有没有问题。如果没有问题就继续扩大升级，直到全部升级完成。
1. AB测试(A/B Testing) 同时上线两个版本，然后做相关的比较。
